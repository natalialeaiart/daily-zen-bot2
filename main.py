import os
import telegram
from openai import OpenAI
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º os –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏, —É–∂–µ –µ—Å—Ç—å

openai_api_key = os.getenv("OPENAI_API_KEY")
telegram_token = os.getenv("TELEGRAM_BOT_TOKEN")
chat_id = "@dailyzendose"

client = OpenAI(api_key=openai_api_key)
bot = telegram.Bot(token=telegram_token)

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ü–µ—Å–Ω–∏ –¥–Ω—è ---
SONGS_FILE = 'youtube_songs.txt' # –ò–º—è —Ñ–∞–π–ª–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–µ—Å–µ–Ω
INDEX_FILE = 'current_song_index.txt' # –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Å–µ–Ω –∏ –∏–Ω–¥–µ–∫—Å–∞ ---
def read_song_list(filename):
    """–ß–∏—Ç–∞–µ—Ç —Å–ø–∏—Å–æ–∫ URL –∏–∑ —Ñ–∞–π–ª–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏."""
    songs = []
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å # (–¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤)
                if line and not line.startswith('#'):
                    songs.append(line)
    except FileNotFoundError:
        print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–µ—Å–µ–Ω '{filename}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        # –í–µ—Ä–Ω–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –º–æ–≥–ª–∞ —ç—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
        return []
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –ø–µ—Å–µ–Ω '{filename}': {e}")
        return []
    return songs

def read_current_index(filename):
    """–ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –ø–µ—Å–Ω–∏ –∏–∑ —Ñ–∞–π–ª–∞."""
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            content = f.read().strip()
            if content:
                # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —á–∏—Å–ª–æ. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∏–Ω–¥–µ–∫—Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.
                return int(content)
            else:
                # –§–∞–π–ª –ø—É—Å—Ç
                return -1
    except FileNotFoundError:
        # –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        return -1
    except ValueError:
        # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–µ —á–∏—Å–ª–æ)
        print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª –∏–Ω–¥–µ–∫—Å–∞ '{filename}' —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ. –ù–∞—á–Ω–µ–º —Å 0.")
        return -1
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∏–Ω–¥–µ–∫—Å–∞ '{filename}': {e}")
        return -1


def write_current_index(filename, index):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –ø–µ—Å–Ω–∏ –≤ —Ñ–∞–π–ª."""
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(str(index))
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞ –∏–Ω–¥–µ–∫—Å–∞ '{filename}': {e}")

# --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –±–æ—Ç–∞ ---

# 1. –ñ—ë—Å—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ü–∏—Ç–∞—Ç—ã
prompt = (
    "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ–¥–Ω—É –º—É–¥—Ä—É—é —Ü–∏—Ç–∞—Ç—É –¥–Ω—è –æ—Ç –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –ø–∏—Å–∞—Ç–µ–ª—è, —Ñ–∏–ª–æ—Å–æ—Ñ–∞, –≥–µ—Ä–æ—è –∫–Ω–∏–≥–∏, —Ñ–∏–ª—å–º–∞ –∏ —Ç.–¥. –í–∞–∂–Ω–æ, —á—Ç–æ–± —Ü–∏—Ç–∞—Ç–∞ –±—ã–ª–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–π, –º—É–¥—Ä–æ–π –∏/–∏–ª–∏ —Å —é–º–æ—Ä–æ–º. "
    "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ –µ—ë –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π. "
    "–°—Ç—Ä–æ–≥–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n\n"
    "\"–ê–Ω–≥–ª–∏–π—Å–∫–∞—è —Ü–∏—Ç–∞—Ç–∞\" ‚Äî –ê–≤—Ç–æ—Ä\n\"–†—É—Å—Å–∫–∞—è —Ü–∏—Ç–∞—Ç–∞\" ‚Äî –ê–≤—Ç–æ—Ä"
)

response = client.chat.completions.create(
    model="gpt-4o",
    messages=[{"role": "user", "content": prompt}]
)

# 2. –†–∞–∑–±–æ—Ä —Ü–∏—Ç–∞—Ç—ã
text = response.choices[0].message.content.strip()
lines = [line for line in text.split("\n") if line.strip()]
english = lines[0].strip('"') if len(lines) >= 1 else ""
russian = lines[1].strip('"') if len(lines) >= 2 else ""

# 3. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ü–∏—Ç–∞—Ç—ã
quote_text = f"Quote of the day:\n\n{english}\n\n–¶–∏—Ç–∞—Ç–∞ –¥–Ω—è:\n\n{russian}" if english and russian else english or text

# 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–º—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
theme_response = client.chat.completions.create(
    model="gpt-4o",
    messages=[
        {
            "role": "user",
            "content": (
                f"–í–æ—Ç —Ü–∏—Ç–∞—Ç–∞:\n\n{english}\n\n"
                "–û–ø—Ä–µ–¥–µ–ª–∏ –µ—ë –≥–ª–∞–≤–Ω—É—é —Ç–µ–º—É –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º –∏–ª–∏ —Ñ—Ä–∞–∑–æ–π (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)."
            )
        }
    ]
)
theme = theme_response.choices[0].message.content.strip()

# 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
image = client.images.generate(
    model="dall-e-3",
    prompt=f"Symbolic concept of {theme}, artistic rendering, elegant, high detail, blend of vintage and cybernetic aesthetics",
    n=1,
    size="1024x1024"
)
image_url = image.data[0].url

# 6. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞ (–§–æ—Ç–æ + –¶–∏—Ç–∞—Ç–∞)
try:
    bot.send_photo(chat_id=chat_id, photo=image_url, caption=quote_text)
    print("–ü–µ—Ä–≤—ã–π –ø–æ—Å—Ç (–§–æ—Ç–æ + –¶–∏—Ç–∞—Ç–∞) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ.")
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞ (–§–æ—Ç–æ + –¶–∏—Ç–∞—Ç–∞): {e}")


# --- 7. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ –ø–æ—Å—Ç–∞ (–ü–µ—Å–Ω—è –¥–Ω—è) ---

print("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ '–ü–µ—Å–Ω–∏ –¥–Ω—è'...")

youtube_songs = read_song_list(SONGS_FILE)

if not youtube_songs:
    print(f"–ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å '–ü–µ—Å–Ω—é –¥–Ω—è': —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω –ø—É—Å—Ç –∏–ª–∏ —Ñ–∞–π–ª '{SONGS_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏.")
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∫–∞–Ω–∞–ª
    # try:
    #     bot.send_message(chat_id=chat_id, text="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω –¥–Ω—è.")
    # except Exception as e_msg:
    #     print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ —Å–ø–∏—Å–∫–∞ –ø–µ—Å–µ–Ω: {e_msg}")

else:
    # –°–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –≤—ã–±–æ—Ä—É —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Å–Ω–∏
    current_index = read_current_index(INDEX_FILE)
    print(f"–¢–µ–∫—É—â–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–µ—Å–Ω–∏: {current_index}")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Å–Ω–∏
    # –ï—Å–ª–∏ read_current_index –≤–µ—Ä–Ω—É–ª -1 (—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω), –Ω–∞—á–Ω–µ–º —Å –∏–Ω–¥–µ–∫—Å–∞ 0
    next_index = current_index + 1 if current_index is not None and current_index != -1 else 0

    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ü–∏–∫–ª–∞: –µ—Å–ª–∏ next_index —Ä–∞–≤–µ–Ω –∏–ª–∏ –±–æ–ª—å—à–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Å–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ 0
    if next_index >= len(youtube_songs):
        next_index = 0
        print("–î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ –ø–µ—Å–µ–Ω, —Å–±—Ä–æ—Å –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ 0.")

    # –ü–æ–ª—É—á–∞–µ–º URL –ø–µ—Å–Ω–∏ –ø–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–º—É –∏–Ω–¥–µ–∫—Å—É
    try:
        song_url = youtube_songs[next_index]

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å "–ü–µ—Å–Ω–µ–π –¥–Ω—è"
        print(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Å–Ω–∏ —Å –∏–Ω–¥–µ–∫—Å–æ–º {next_index}: {song_url}")
        bot.send_message(
            chat_id=chat_id,
            text=f"Song Of The Day - –ü–µ—Å–Ω—è –î–Ω—è üéßüåü\n\n{song_url}"
        )
        print(f"'–ü–µ—Å–Ω—è –¥–Ω—è' —Å –∏–Ω–¥–µ–∫—Å–æ–º {next_index} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.")

        # –í–∞–∂–Ω–æ: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        write_current_index(INDEX_FILE, next_index)
        print(f"–ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å {next_index} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω –≤ —Ñ–∞–π–ª '{INDEX_FILE}'.")

    except IndexError:
         print(f"–û—à–∏–±–∫–∞: –ò–Ω–¥–µ–∫—Å –ø–µ—Å–Ω–∏ {next_index} –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ ({len(youtube_songs)} –ø–µ—Å–µ–Ω). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª '{SONGS_FILE}'.")
         # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∫–∞–Ω–∞–ª
         # try:
         #     bot.send_message(chat_id=chat_id, text="–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Å–Ω–∏ –¥–Ω—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω.")
         # except Exception as e_msg:
         #      print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –≤—ã–±–æ—Ä–∞ –ø–µ—Å–Ω–∏: {e_msg}")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–µ—Å–Ω–µ–π –¥–Ω—è: {e}")
        # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –º—ã –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª –∏–Ω–¥–µ–∫—Å–∞,
        # —á—Ç–æ–±—ã –±–æ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—É –∂–µ –ø–µ—Å–Ω—é –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑.

# –ö–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞
